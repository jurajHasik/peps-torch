

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ctm.one_site_c4v.rdm_c4v &mdash; peps-torch alpha documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> peps-torch
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ipeps.html">iPEPS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipeps.html">Generic iPEPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipeps_kagome.html">Kagome iPEPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipeps_c4v.html">1-site C4v iPEPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipeps_lc_1site_pg.html">1-site iPEPS from lin. combination</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipess_kagome.html">Generic Kagome iPESS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipess_kagome_pg.html">Kagome iPESS with point groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipess_kagome_pg_lc.html">Kagome iPESS from lin. combination</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ipeps.html#abelian-symmetric-ipeps">Abelian-symmetric iPEPS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipeps_abelian.html">Generic  abelian-symmetric iPEPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipeps_abelian.html#generic-abelian-symmetric-ipeps-with-weights">Generic abelian-symmetric iPEPS with weights</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipeps_kagome_abelian.html">Abelian-symmetric Kagome iPEPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipeps_abelian_c4v.html">Abelian-symmetric 1-site C4v iPEPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ipeps/ipess_kagome_abelian.html">Abelian-symmetric generic Kagome iPESS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../envs.html">Environments</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../envs/generic.html">Generic iPEPS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic/env.html">Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic/ctmrg.html">Corner Transfer Matrix Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic/ctm_projectors.html">Projectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic/ctm_components.html">Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic/rdm.html">Reduced Density Matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic/rdm.html#module-ctm.pess_kagome.rdm_kagome">Specific RDMs for Kagome iPEPS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic/corrf.html">Correlation functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic/transfer_matrix.html">Transfer Matrices</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../envs/generic_abelian.html">Abelian-symmetric generic iPEPS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic_abelian/env_abelian.html">Abelian-symmetric environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic_abelian/ctmrg.html">Corner Transfer Matrix Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic_abelian/ctm_projectors.html">Projectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic_abelian/ctm_components.html">Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic_abelian/rdm.html">Reduced Density Matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/generic_abelian/rdm.html#module-ctm.pess_kagome_abelian.rdm_kagome">Specific RDMs for Kagome iPEPS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../envs/one_site_c4v.html">1-site C4v iPEPS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/one_site_c4v/env_c4v.html">1-site C4v Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/one_site_c4v/ctmrg_c4v.html">Corner Transfer Matrix Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/one_site_c4v/rdm_c4v.html">Reduced Density Matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/one_site_c4v/transfer_matrix.html">Transfer Matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/one_site_c4v/corrf_c4v.html">Correlation functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../envs/one_site_c4v_abelian.html">Abelian-symmetric 1-site C4v iPEPS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/one_site_c4v_abelian/env_c4v_abelian.html">Abelian-symmetric 1-site C4v Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/one_site_c4v_abelian/ctmrg_c4v_abelian.html">Corner Transfer Matrix Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/one_site_c4v_abelian/rdm_c4v_abelian.html">Reduced Density Matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../envs/one_site_c4v_abelian/corrf_c4v_abelian.html">Correlation functions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">Optimization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../optim/drivers.html">Optimization drivers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../optim/drivers/ad_optim.html">ad_optim</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../optim/drivers/ad_optim_lbfgs_mod.html">ad_optim_lbfgs_mod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../optim/drivers/ad_optim_sgd_mod.html">ad_optim_sgd_mod</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../optim/optimizers.html">Custom optimizers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../optim/optimizers/lbfgs_modified.html">Extended LBFGS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../optim/optimizers/sgd_modified.html">SGD with linesearch</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../config.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../config.html#main">Main</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../config.html#global">Global</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../config.html#corner-transfer-matrix-algorithm">Corner Transfer Matrix Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../config.html#optimization">Optimization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.html">Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../models/akltS2.html">Spin S=2 AKLT Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../models/akltS2.html#module-models.akltS2">2x1 and 2x2 unit cell</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/akltS2.html#x1-c4v">1x1 C4v</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../models/coupledLadders.html">Coupled Ladders</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../models/coupledLadders.html#dense-pytorch">Dense (PyTorch)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/coupledLadders.html#dense-yast">Dense (YAST)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/coupledLadders.html#with-explict-u-1-symmetry">With explict U(1) symmetry</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../models/ising.html">Transverse Field Ising Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../models/ising.html#x1-unit-cell">1x1 unit cell</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/ising.html#x1-c4v">1x1 C4v</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../models/j1j2.html">J1-J2-J3 and J1-J2-lambda Heisenberg Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../models/j1j2.html#from-2x1-to-4x2-unit-cell-pytorch">from 2x1 to 4x2 unit cell (PyTorch)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/j1j2.html#from-2x1-to-4x2-unit-cell-dense-yast">from 2x1 to 4x2 unit cell (dense YAST)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/j1j2.html#x1-c4v-pytorch">1x1 C4v (PyTorch)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/j1j2.html#x1-c4v-dense-yast">1x1 C4v (dense YAST)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../models/jq.html">J-Q Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../models/jq.html#module-models.jq">2x2 unit cell</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/jq.html#x1-c4v">1x1 C4v</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../models/spin_half_kagome.html">SU(2) model on Kagome lattice</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../models/spin_half_kagome.html#dense">Dense</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/spin_half_kagome.html#with-explict-u-1-symmetry">With explict U(1) symmetry</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../models/su3_kagome.html">SU(3) model on Kagome lattice</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../models/su3_kagome.html#dense">Dense</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../models/su3_kagome.html#with-explict-u-1-xu-1-symmetry">With explict U(1)xU(1) symmetry</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../groups.html">Groups</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../groups/pg.html">Point group: square lattice</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../groups/su2.html">SU(2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../groups/su2.html#module-groups.su2_abelian">SU(2) with explicit U(1) structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../groups/su3.html">SU(3)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../groups/su3.html#su-3-with-explicit-u-1-xu-1-structure">SU(3) with explicit U(1)xU(1) structure</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">Linear Algebra</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../linalg/custom_eig.html">Truncated eigendecomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../linalg/custom_svd.html">Truncated SVD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../linalg/spec_decomp.html">Spectral decompositions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../linalg/spec_decomp.html#module-linalg.svd_gesdd">SVD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../linalg/spec_decomp.html#module-linalg.svd_arnoldi">Partial SVD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../linalg/spec_decomp.html#module-linalg.svd_rsvd">Randomized SVD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../linalg/spec_decomp.html#module-linalg.eig_sym">Symmetric Eigendecomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../linalg/spec_decomp.html#module-linalg.eig_arnoldi">Partial diagonalization</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">peps-torch</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ctm.one_site_c4v.rdm_c4v</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ctm.one_site_c4v.rdm_c4v</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">ipeps.ipeps_c4v</span> <span class="kn">import</span> <span class="n">IPEPS_C4V</span>
<span class="kn">from</span> <span class="nn">ctm.one_site_c4v.env_c4v</span> <span class="kn">import</span> <span class="n">ENV_C4V</span>
<span class="kn">from</span> <span class="nn">ctm.generic.rdm</span> <span class="kn">import</span> <span class="n">_sym_pos_def_rdm</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># ----- components -------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_log_cuda_mem</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>  <span class="n">uuid</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2"> GPU-MEM MAX_ALLOC </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">max_memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>\
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; CURRENT_ALLOC </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_open_C2x2_LU_sl</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;_get_open_C2x2_LU_sl&quot;</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    
    <span class="c1">#      ------&gt;   </span>
    <span class="c1"># C--1 1--T--0-&gt;1</span>
    <span class="c1"># 0       2</span>
    <span class="c1"># C2x2= torch.tensordot(C, T, ([1],[0]))</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CT&quot;</span><span class="p">)</span>
        

    <span class="c1">#   C------T--1-&gt;0</span>
    <span class="c1">#   0      2-&gt;1</span>
    <span class="c1"># A 0</span>
    <span class="c1"># | T--2-&gt;3</span>
    <span class="c1"># | 1-&gt;2</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTT&quot;</span><span class="p">)</span>

    <span class="c1"># 4i) untangle the fused D^2 indices</span>
    <span class="c1">#</span>
    <span class="c1"># C------T--0</span>
    <span class="c1"># 0      1-&gt;1,2</span>
    <span class="c1"># 0</span>
    <span class="c1"># T--3-&gt;4,5</span>
    <span class="c1"># 2-&gt;3</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span>\
        <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># 4ii) first layer &quot;bra&quot; (in principle conjugate)</span>
    <span class="c1"># </span>
    <span class="c1"># C---------T----0</span>
    <span class="c1"># |         |\---2-&gt;1</span>
    <span class="c1"># |         1    </span>
    <span class="c1"># |         1 /0-&gt;4</span>
    <span class="c1"># T----4 2--a--4-&gt;6 </span>
    <span class="c1"># | |       3-&gt;5</span>
    <span class="c1"># |  --5-&gt;3</span>
    <span class="c1"># 3-&gt;2</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTa_init&quot;</span><span class="p">)</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">a</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTa_end&quot;</span><span class="p">)</span>
    
    <span class="c1"># 4iii) second layer &quot;ket&quot;</span>
    <span class="c1"># </span>
    <span class="c1"># C----T----------0</span>
    <span class="c1"># |    |\-----\</span>
    <span class="c1"># |    |       1</span>
    <span class="c1"># |    |/4-&gt;2  |</span>
    <span class="c1"># T----a----------6-&gt;4 </span>
    <span class="c1"># | |  |       1/0-&gt;5</span>
    <span class="c1"># |  -----3 2--a--4-&gt;7</span>
    <span class="c1"># |    |       3-&gt;6</span>
    <span class="c1"># |    |</span>
    <span class="c1"># 2-&gt;1 5-&gt;3</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTaa_init&quot;</span><span class="p">)</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTaa_end&quot;</span><span class="p">)</span>

    <span class="c1"># 4iv) fuse pairs of aux indices</span>
    <span class="c1">#</span>
    <span class="c1">#  C------T----0\</span>
    <span class="c1">#  |    2\|\     \</span>
    <span class="c1">#  T------a----4\ \ </span>
    <span class="c1">#  | \    | |    -&gt;-&gt;1</span>
    <span class="c1">#  |  ------a--7/</span>
    <span class="c1">#  |      | |\5-&gt;3</span>
    <span class="c1"># (1     (3 6))-&gt;0</span>
    <span class="c1"># </span>
    <span class="c1"># permute and reshape 01234567-&gt;(136)(047)25-&gt;0123</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>\
        <span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">C2x2</span>

<span class="k">def</span> <span class="nf">_get_open_C2x2_LU_dl</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;_get_open_C2x2_LU_dl&quot;</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">dimsa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mefgh,nabcd-&gt;eafbgchdmn&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1">#      ------&gt;</span>
    <span class="c1"># C--1 1--T--0-&gt;1</span>
    <span class="c1"># 0       2</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1">#   C------T--1-&gt;0</span>
    <span class="c1">#   0      2-&gt;1</span>
    <span class="c1"># A 0</span>
    <span class="c1"># | T--2-&gt;3</span>
    <span class="c1"># | 1-&gt;2</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1"># C-------T--0</span>
    <span class="c1"># |       1</span>
    <span class="c1"># |       0</span>
    <span class="c1"># T--3 1--A--3</span>
    <span class="c1"># 2-&gt;1    2\45</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1"># permute 012345-&gt;120345</span>
    <span class="c1"># reshape (12)(03)45-&gt;0123</span>
    <span class="c1"># C2x2--1</span>
    <span class="c1"># |\23</span>
    <span class="c1"># 0</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>\
        <span class="n">T</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">T</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">C2x2</span>

<span class="k">def</span> <span class="nf">_get_aux_C2x2_LU</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;_get_aux_C2x2_LU&quot;</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="c1">#      ------&gt;</span>
    <span class="c1"># C--1 1--T--0-&gt;1</span>
    <span class="c1"># 0       2</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1">#   C------T--1-&gt;2</span>
    <span class="c1">#   0      2-&gt;3</span>
    <span class="c1"># A 0</span>
    <span class="c1"># | T--2-&gt;1</span>
    <span class="c1"># | 1-&gt;0</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">C2x2</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1"># |C2x2____|--2    |C2x2____|--1  </span>
    <span class="c1"># | |     3        | |     3 </span>
    <span class="c1"># |_|--1        =&gt; |_|--2</span>
    <span class="c1">#  0                0</span>
    <span class="c1">#</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">C2x2</span>

<span class="c1"># ----- density matrices in physical space -------------------------------------</span>
<div class="viewcode-block" id="rdm1x1"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm1x1">[docs]</a><span class="k">def</span> <span class="nf">rdm1x1</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 1-site reduced density matrix with indices :math:`s;s&#39;`</span>
<span class="sd">    :rtype: torch.tensor</span>
<span class="sd">    </span>
<span class="sd">    Computes 1-site reduced density matrix :math:`\rho_{1x1}` by </span>
<span class="sd">    contracting the following tensor network::</span>

<span class="sd">        C--T-----C</span>
<span class="sd">        |  |     |</span>
<span class="sd">        T--a^+a--T</span>
<span class="sd">        |  |     |</span>
<span class="sd">        C--T-----C</span>

<span class="sd">    where the physical indices `s` and `s&#39;` of on-site tensor :math:`a` </span>
<span class="sd">    and its hermitian conjugate :math:`a^\dagger` are left uncontracted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;rdm1x1&quot;</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
    <span class="c1">#   C--1-&gt;0</span>
    <span class="c1">#   0</span>
    <span class="c1"># A 0</span>
    <span class="c1"># | T--2</span>
    <span class="c1"># | 1</span>
    <span class="n">CTC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">T</span><span class="p">,([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1">#   C--0</span>
    <span class="c1"># A |</span>
    <span class="c1"># | T--2-&gt;1</span>
    <span class="c1"># | 1</span>
    <span class="c1">#   0</span>
    <span class="c1">#   C--1-&gt;2</span>
    <span class="n">CTC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">CTC</span><span class="p">,</span><span class="n">C</span><span class="p">,([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># C--0</span>
    <span class="c1"># |</span>
    <span class="c1"># T--1</span>
    <span class="c1"># |       2-&gt;3</span>
    <span class="c1"># C--2 0--T--1-&gt;2</span>
    <span class="c1">#      &lt;------</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">CTC</span><span class="p">,</span><span class="n">T</span><span class="p">,([</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># TODO - more efficent contraction with uncontracted-double-layer on-site tensor</span>
    <span class="c1">#        Possibly reshape indices 1,2 of rdm, which are to be contracted with </span>
    <span class="c1">#        on-site tensor and contract bra,ket in two steps instead of creating </span>
    <span class="c1">#        double layer tensor</span>
    <span class="c1">#    /</span>
    <span class="c1"># --A--</span>
    <span class="c1">#  /|s</span>
    <span class="c1">#  </span>
    <span class="c1"># s&#39;|/</span>
    <span class="c1"># --A--</span>
    <span class="c1">#  /</span>
    <span class="c1">#</span>
    <span class="n">A</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">dimsA</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mefgh,nabcd-&gt;eafbgchdmn&#39;</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">A</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dimsA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsA</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsA</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dimsA</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># C--0</span>
    <span class="c1"># |</span>
    <span class="c1"># |       0-&gt;2</span>
    <span class="c1"># T--1 1--a--3</span>
    <span class="c1"># |       2\45(s,s&#39;)</span>
    <span class="c1"># |       3</span>
    <span class="c1"># C-------T--2-&gt;1</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span><span class="n">a</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1">#      ------&gt;</span>
    <span class="c1"># C--0 1--T--0</span>
    <span class="c1"># |       2</span>
    <span class="c1"># |       2</span>
    <span class="c1"># T-------a--3-&gt;2</span>
    <span class="c1"># |       |\45-&gt;34(s,s&#39;)</span>
    <span class="c1"># |       |</span>
    <span class="c1"># C-------T--1</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">rdm</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="c1"># C--T---0 2--------C</span>
    <span class="c1"># |  |              |</span>
    <span class="c1"># |  |              | |</span>
    <span class="c1"># T--a---2 1--------T |</span>
    <span class="c1"># |  |\34-&gt;01(s,s&#39;) | V</span>
    <span class="c1"># |  |              |</span>
    <span class="c1"># C--T---1 0--------C</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span><span class="n">CTC</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span>  <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span></div>

<div class="viewcode-block" id="rdm1x1_sl"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm1x1_sl">[docs]</a><span class="k">def</span> <span class="nf">rdm1x1_sl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 1-site reduced density matrix with indices :math:`s;s&#39;`</span>
<span class="sd">    :rtype: torch.tensor</span>
<span class="sd">    </span>
<span class="sd">    Evaluates 1-site operator :math:`Tr(\rho_{1x1}O)` by </span>
<span class="sd">    contracting the following tensor network::</span>

<span class="sd">        C--T-----C</span>
<span class="sd">        |  |     |</span>
<span class="sd">        T--a^+a--T</span>
<span class="sd">        |  |     |</span>
<span class="sd">        C--T-----C</span>

<span class="sd">    where the physical indices `s` and `s&#39;` of on-site tensor :math:`a` </span>
<span class="sd">    and its hermitian conjugate :math:`a^\dagger` are left uncontracted.</span>

<span class="sd">    This function avoids constructing double-layer on-site tensor explicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;rdm1x1_sl&quot;</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
    <span class="c1">#   C--1-&gt;0</span>
    <span class="c1">#   0</span>
    <span class="c1"># A 0</span>
    <span class="c1"># | T--2</span>
    <span class="c1"># | 1</span>
    <span class="n">CTC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">T</span><span class="p">,([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1">#   C--0</span>
    <span class="c1"># A |</span>
    <span class="c1"># | T--2-&gt;1</span>
    <span class="c1"># | 1</span>
    <span class="c1">#   0</span>
    <span class="c1">#   C--1-&gt;2</span>
    <span class="n">CTC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">CTC</span><span class="p">,</span><span class="n">C</span><span class="p">,([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1"># C--0</span>
    <span class="c1"># |</span>
    <span class="c1"># T--1</span>
    <span class="c1"># |       2-&gt;3</span>
    <span class="c1"># C--2 0--T--1-&gt;2</span>
    <span class="c1">#      &lt;------</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">CTC</span><span class="p">,</span><span class="n">T</span><span class="p">,([</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="c1"># 4i) untangle the fused D^2 indices</span>
    <span class="c1">#</span>
    <span class="c1"># C--0</span>
    <span class="c1"># |</span>
    <span class="c1"># T--1-&gt;1,2</span>
    <span class="c1"># |    3-&gt;4,5</span>
    <span class="c1"># C----T--2-&gt;3</span>
    <span class="n">a</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">rdm</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span><span class="n">rdm</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">3</span><span class="p">],</span>\
        <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1">#    /</span>
    <span class="c1"># --a--</span>
    <span class="c1">#  /|s&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#  s|/</span>
    <span class="c1"># --a--</span>
    <span class="c1">#  /</span>
    <span class="c1">#</span>

    <span class="c1"># 4ii) first layer &quot;bra&quot; (in principle conjugate)</span>
    <span class="c1"># C--0    -&gt;5</span>
    <span class="c1"># |       1/0-&gt;4</span>
    <span class="c1"># T--1 2--a--4-&gt;6</span>
    <span class="c1"># |\2-&gt;1  3</span>
    <span class="c1"># |       4 5-&gt;3</span>
    <span class="c1"># |       |/</span>
    <span class="c1"># C-------T--3-&gt;2</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span><span class="n">a</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]))</span>
    
    <span class="c1"># 4iii) second layer &quot;ket&quot;</span>
    <span class="c1"># C--0</span>
    <span class="c1"># |   5-&gt;3     1-&gt;6</span>
    <span class="c1"># |  -|---1 2--a--4-&gt;7</span>
    <span class="c1"># | / |        3\0-&gt;5</span>
    <span class="c1"># |/  |/4-&gt;2   3</span>
    <span class="c1"># T---a-----------6-&gt;4</span>
    <span class="c1"># |   | ------/</span>
    <span class="c1"># |   |/</span>
    <span class="c1"># C---T-----------2-&gt;1</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]))</span>

    <span class="c1"># 4iv) fuse pairs of aux indices    </span>
    <span class="c1"># C--0 (3 6)-&gt;2</span>
    <span class="c1"># |     | |/5</span>
    <span class="c1"># | ----|-a--7\</span>
    <span class="c1"># |/    | |    &gt;3</span>
    <span class="c1"># T-----a----4/</span>
    <span class="c1"># |4&lt;-2/| |</span>
    <span class="c1"># |     |/</span>
    <span class="c1"># C-----T----1</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">rdm</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">rdm</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>\
        <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1">#      ------&gt;</span>
    <span class="c1"># C--0 1--T--0</span>
    <span class="c1"># |       2</span>
    <span class="c1"># |       2</span>
    <span class="c1"># T-------a--3-&gt;2</span>
    <span class="c1"># |       |\45-&gt;34(s,s&#39;)</span>
    <span class="c1"># |       |</span>
    <span class="c1"># C-------T--1</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">rdm</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># C--T--0 2---------C</span>
    <span class="c1"># |  |              |</span>
    <span class="c1"># |  |              | |</span>
    <span class="c1"># T--a--2 1---------T |</span>
    <span class="c1"># |  |\34-&gt;01(s,s&#39;) | V</span>
    <span class="c1"># |  |              |</span>
    <span class="c1"># C--T--1 0---------C</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span><span class="n">CTC</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span></div>


<div class="viewcode-block" id="rdm2x1"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm2x1">[docs]</a><span class="k">def</span> <span class="nf">rdm2x1</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param sym_pos_def: make final density matrix symmetric and non-negative (default: False)</span>
<span class="sd">    :type sym_pos_def: bool</span>
<span class="sd">    :param force_cpu: perform on CPU</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 2-site reduced density matrix with indices :math:`s_0s_1;s&#39;_0s&#39;_1`</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 2-site reduced density matrix :math:`\rho_{2x1}` of a horizontal </span>
<span class="sd">    2x1 subsystem using following strategy:</span>
<span class="sd">    </span>
<span class="sd">        1. compute upper left 2x2 corner and lower left 2x1 corner</span>
<span class="sd">        2. construct left half of the network</span>
<span class="sd">        3. contract left and right half (identical to the left) to obtain final </span>
<span class="sd">           reduced density matrix</span>

<span class="sd">    ::</span>

<span class="sd">        C--T-----T-----C = C2x2--C2x2</span>
<span class="sd">        |  |     |     |   |     |  </span>
<span class="sd">        T--a^+a--a^+a--T   C2x1--C2x1</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        C--T-----T-----C </span>

<span class="sd">    The physical indices `s` and `s&#39;` of on-sites tensors :math:`a` (and :math:`a^\dagger`) </span>
<span class="sd">    are left uncontracted and given in the following order::</span>
<span class="sd">        </span>
<span class="sd">        s0 s1</span>

<span class="sd">    The resulting reduced density matrix is identical to the one of vertical 1x2 subsystem</span>
<span class="sd">    due to the C4v symmetry. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;rdm2x1&quot;</span>
    <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
        <span class="c1"># move to cpu</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="n">loc_device</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">log_gpu_mem</span><span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ten_size</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>

    <span class="c1">#----- building C2x2_LU ----------------------------------------------------</span>
    <span class="n">dimsa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">A</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mefgh,nabcd-&gt;eafbgchdmn&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1">#      ------&gt;</span>
    <span class="c1"># C--1 1--T--0-&gt;1</span>
    <span class="c1"># 0       2</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CT_init&quot;</span><span class="p">)</span>
    <span class="n">C2x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CT_end&quot;</span><span class="p">)</span>

    <span class="c1">#   C------T--1-&gt;0</span>
    <span class="c1">#   0      2-&gt;1</span>
    <span class="c1"># A 0</span>
    <span class="c1"># | T2--2-&gt;3</span>
    <span class="c1"># | 1-&gt;2</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTT_init&quot;</span><span class="p">)</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x1</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTT_end&quot;</span><span class="p">)</span>

    <span class="c1"># C-------T--0</span>
    <span class="c1"># |       1</span>
    <span class="c1"># |       0</span>
    <span class="c1"># T2--3 1 A--3</span>
    <span class="c1"># 2-&gt;1    2\45</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTA_init&quot;</span><span class="p">)</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTA_end&quot;</span><span class="p">)</span>

    <span class="c1"># permute 012345-&gt;120345</span>
    <span class="c1">#   ---&gt;</span>
    <span class="c1"># A C2x2--2</span>
    <span class="c1"># | |__|--3</span>
    <span class="c1">#   | | \45</span>
    <span class="c1">#   0 1</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># 0       2</span>
    <span class="c1"># C--1 0--T--1</span>
    <span class="c1">#      &lt;------</span>
    <span class="n">C2x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1">#----- build left part C2x2_LU--C2x1_LD ------------------------------------</span>
    <span class="c1">#   ---&gt;     </span>
    <span class="c1"># A C2x2--2-&gt;1</span>
    <span class="c1"># | |__|--3-&gt;2</span>
    <span class="c1">#   | |\45-&gt;34</span>
    <span class="c1">#   0 1</span>
    <span class="c1">#   0 2</span>
    <span class="c1">#   C2x1--1-&gt;0</span>
    <span class="c1">#   &lt;---</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTATC_init&quot;</span><span class="p">)</span>
    <span class="n">left_half</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x1</span><span class="p">,</span> <span class="n">C2x2</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTATC_end&quot;</span><span class="p">)</span>

    <span class="c1"># construct reduced density matrix by contracting left and right halfs</span>
    <span class="c1"># ---&gt;         ---&gt;</span>
    <span class="c1"># C2x2--1 0----C2x1</span>
    <span class="c1"># |__|--2 2--\ |</span>
    <span class="c1"># |\34-&gt;01    \|__/34-&gt;23</span>
    <span class="c1"># |            |  |</span>
    <span class="c1"># C2x1--0 1----C2x2</span>
    <span class="c1"># &lt;---         &lt;---</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;rdm_init&quot;</span><span class="p">)</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">left_half</span><span class="p">,</span><span class="n">left_half</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;rdm_end&quot;</span><span class="p">)</span>

    <span class="c1"># permute into order of s0,s1;s0&#39;,s1&#39; where primed indices</span>
    <span class="c1"># represent &quot;ket&quot;</span>
    <span class="c1"># 0123-&gt;0213</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span></div>

<div class="viewcode-block" id="rdm2x1_sl"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm2x1_sl">[docs]</a><span class="k">def</span> <span class="nf">rdm2x1_sl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param sym_pos_def: make final density matrix symmetric and non-negative (default: False)</span>
<span class="sd">    :type sym_pos_def: bool</span>
<span class="sd">    :param force_cpu: compute on cpu</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 2-site reduced density matrix with indices :math:`s_0s_1;s&#39;_0s&#39;_1`</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 2-site reduced density matrix :math:`\rho_{2x1}` of a horizontal </span>
<span class="sd">    2x1 subsystem using following strategy:</span>
<span class="sd">    </span>
<span class="sd">        1. compute upper left 2x2 corner and lower left 2x1 corner</span>
<span class="sd">        2. construct left half of the network</span>
<span class="sd">        3. contract left and right half (identical to the left) to obtain final </span>
<span class="sd">           reduced density matrix</span>

<span class="sd">    ::</span>

<span class="sd">        C--T-----T-----C = C2x2--C2x2</span>
<span class="sd">        |  |     |     |   |     |  </span>
<span class="sd">        T--a^+a--a^+a--T   C2x1--C2x1</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        C--T-----T-----C </span>

<span class="sd">    The physical indices `s` and `s&#39;` of on-sites tensors :math:`a` (and :math:`a^\dagger`) </span>
<span class="sd">    are left uncontracted and given in the following order::</span>
<span class="sd">        </span>
<span class="sd">        s0 s1</span>

<span class="sd">    The resulting reduced density matrix is identical to the one of vertical 1x2 subsystem</span>
<span class="sd">    due to the C4v symmetry. </span>

<span class="sd">    This function avoids constructing double-layer on-site tensor explicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;rdm2x1_sl&quot;</span>
    <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
        <span class="c1"># move to cpu</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="c1">#----- building C2x2_LU ----------------------------------------------------</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ten_size</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>

    <span class="c1">#      ------&gt;</span>
    <span class="c1"># C--1 1--T--0-&gt;1</span>
    <span class="c1"># 0       2</span>
    <span class="n">C2x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x1: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># see _get_open_C2x2_LU_sl</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x1</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>\
        <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">a</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x1,C2x2: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x1</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 4iv) fuse (some) pairs of aux indices</span>
    <span class="c1">#</span>
    <span class="c1"># C------T----0-&gt;2</span>
    <span class="c1"># | 4&lt;-2\|\    </span>
    <span class="c1"># T------a----4\</span>
    <span class="c1"># | \    | |    -&gt;-&gt;3</span>
    <span class="c1"># |  ------a--7/</span>
    <span class="c1"># |      | |\5</span>
    <span class="c1"># 1-&gt;0  (3 6)-&gt;1</span>
    <span class="c1"># </span>
    <span class="c1"># permute and reshape 01234567-&gt;1(36)0(47)25-&gt;012345</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>\
        <span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x1,C2x2: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x1</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                  
    <span class="c1"># 0       2          0  2</span>
    <span class="c1"># C--1 0--T--1-&gt;1 -&gt; C--T--1</span>
    <span class="c1">#      &lt;------</span>
    <span class="n">C2x1</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1">#----- build left part C2x2_LU--C2x1_LD ------------------------------------</span>
    <span class="c1">#   ---&gt;</span>
    <span class="c1"># A C2x2--2-&gt;1</span>
    <span class="c1"># | |__|--3-&gt;2</span>
    <span class="c1">#   | | \45-&gt;34</span>
    <span class="c1">#   0 1</span>
    <span class="c1">#   0 2</span>
    <span class="c1">#   C2x1--1-&gt;0</span>
    <span class="c1">#   &lt;---</span>
    <span class="n">left_half</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x1</span><span class="p">,</span> <span class="n">C2x2</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> left_half: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">left_half</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># construct reduced density matrix by contracting left and right halfs</span>
    <span class="c1"># ---&gt;         ---&gt;</span>
    <span class="c1"># C2x2--1 0----C2x1</span>
    <span class="c1"># |__|--2 2--\ |</span>
    <span class="c1"># |\34-&gt;01    \|__/34-&gt;23</span>
    <span class="c1"># |            |  |</span>
    <span class="c1"># C2x1--0 1----C2x2</span>
    <span class="c1"># &lt;---         &lt;---</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">left_half</span><span class="p">,</span><span class="n">left_half</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> rdm: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">rdm</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># permute into order of s0,s1;s0&#39;,s1&#39; where primed indices</span>
    <span class="c1"># represent &quot;ket&quot;</span>
    <span class="c1"># 0123-&gt;0213</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span></div>


<div class="viewcode-block" id="rdm3x1"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm3x1">[docs]</a><span class="k">def</span> <span class="nf">rdm3x1</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param sym_pos_def: make final density matrix symmetric and non-negative (default: False)</span>
<span class="sd">    :type sym_pos_def: bool</span>
<span class="sd">    :param force_cpu: perform on CPU</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 2-site reduced density matrix with indices :math:`s_0s_1;s&#39;_0s&#39;_1`</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 2-site reduced density matrix :math:`\rho_{3x1}` of a horizontal </span>
<span class="sd">    3x1 subsystem using following strategy:</span>
<span class="sd">    </span>
<span class="sd">        1. compute upper left 2x2 corner and lower left 2x1 corner</span>
<span class="sd">        2. construct left half of the network</span>
<span class="sd">        3. contract with extra T-a^+a-T column</span>
<span class="sd">        4. contract result with right half (identical to the left of step 2) to obtain final </span>
<span class="sd">           reduced density matrix</span>

<span class="sd">    ::</span>

<span class="sd">        C--T-----T-----T------C = C2x2--T----C2x2</span>
<span class="sd">        |  |     |     |      |     |   a^+a  |</span>
<span class="sd">        T--a^+a--a^+a--a^+a---T   C2x1--T----C2x1</span>
<span class="sd">        |  |     |     |      |</span>
<span class="sd">        C--T-----T-----T------C </span>

<span class="sd">    The physical indices `s` and `s&#39;` of on-sites tensors :math:`a` (and :math:`a^\dagger`) </span>
<span class="sd">    are left uncontracted and given in the following order::</span>
<span class="sd">        </span>
<span class="sd">        s0 c s1</span>

<span class="sd">    The resulting reduced density matrix is identical to the one of vertical 1x3 subsystem</span>
<span class="sd">    due to the C4v symmetry. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;rdm3x1&quot;</span>
    <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
        <span class="c1"># move to cpu</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="n">loc_device</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">log_gpu_mem</span><span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ten_size</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>

    <span class="c1">#----- building C2x2_LU ----------------------------------------------------</span>
    <span class="n">dimsa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">A_open</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mefgh,nabcd-&gt;eafbgchdmn&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">A</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abcdii-&gt;abcd&#39;</span><span class="p">,</span><span class="n">A_open</span><span class="p">)</span>

    <span class="c1">#      ------&gt;</span>
    <span class="c1"># C--1 1--T--0</span>
    <span class="c1"># 0       2</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CT_init&quot;</span><span class="p">)</span>
    <span class="n">C2x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CT_end&quot;</span><span class="p">)</span>

    <span class="c1"># C------T--1-&gt;0</span>
    <span class="c1"># 0      2-&gt;1</span>
    <span class="c1"># 0</span>
    <span class="c1"># T2--2-&gt;3</span>
    <span class="c1"># 1-&gt;2</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTT_init&quot;</span><span class="p">)</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x1</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTT_end&quot;</span><span class="p">)</span>

    <span class="c1"># C-------T--0</span>
    <span class="c1"># |       1</span>
    <span class="c1"># |       0</span>
    <span class="c1"># T2--3 1 A_open--3</span>
    <span class="c1"># 2-&gt;1    2\45</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTA_init&quot;</span><span class="p">)</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">A_open</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTA_end&quot;</span><span class="p">)</span>

    <span class="c1"># permute 012345-&gt;120345</span>
    <span class="c1">#   ---&gt;</span>
    <span class="c1"># A C2x2--2</span>
    <span class="c1"># | |__|--3</span>
    <span class="c1">#   | |\45</span>
    <span class="c1">#   0 1</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># 0       2</span>
    <span class="c1"># C--1 0--T--1</span>
    <span class="c1">#      &lt;------</span>
    <span class="n">C2x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1">#----- build left part C2x2_LU--C2x1_LD ------------------------------------</span>
    <span class="c1"># ---&gt;</span>
    <span class="c1"># C2x2--2-&gt;1</span>
    <span class="c1"># |__|--3-&gt;2</span>
    <span class="c1"># | |\34</span>
    <span class="c1"># 0 1</span>
    <span class="c1"># 0 2</span>
    <span class="c1"># C2x1--1-&gt;0</span>
    <span class="c1"># &lt;---</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTATC_init&quot;</span><span class="p">)</span>
    <span class="n">left_half</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x1</span><span class="p">,</span> <span class="n">C2x2</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;CTTATC_end&quot;</span><span class="p">)</span>

    <span class="c1">#---- append extra T-a^+a-T column</span>
    <span class="c1">#</span>
    <span class="c1"># /--34-&gt;45</span>
    <span class="c1"># C2x2--1-&gt;2</span>
    <span class="c1"># |  |--2-&gt;3   2-&gt;1</span>
    <span class="c1"># C2x1--0 0----T--1-&gt;0</span>
    <span class="c1">#             &lt;----</span>
    <span class="n">r3x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">left_half</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1"># /--45</span>
    <span class="c1"># C2x2--2-&gt;3</span>
    <span class="c1"># |</span>
    <span class="c1"># |__        0</span>
    <span class="c1"># |  |--3 1--A--3-&gt;1</span>
    <span class="c1"># |  |       2</span>
    <span class="c1"># |  |       1</span>
    <span class="c1"># C2x1-------T--0-&gt;2</span>
    <span class="n">r3x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">r3x1</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="c1"># /--45-&gt;34 ---&gt;</span>
    <span class="c1"># C2x2--3 1--T--0-&gt;0 </span>
    <span class="c1"># |          2</span>
    <span class="c1"># |__        0</span>
    <span class="c1"># |  |-------A--1</span>
    <span class="c1"># C2x1-------T--2</span>
    <span class="c1">#          &lt;---</span>
    <span class="n">r3x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">r3x1</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># construct reduced density matrix by contracting 2x1 channel with right half</span>
    <span class="c1">#   /--34-&gt;01        /--34-&gt;23</span>
    <span class="c1"># A C2x2----T--0 0--C2x1</span>
    <span class="c1"># | |  |    |       |    |</span>
    <span class="c1"># | |  |----A--1 2--|    |</span>
    <span class="c1">#   C2x1----T--2 1--C2x2 V</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;rdm_init&quot;</span><span class="p">)</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">r3x1</span><span class="p">,</span><span class="n">left_half</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">log_gpu_mem</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">,</span><span class="s2">&quot;rdm_end&quot;</span><span class="p">)</span>

    <span class="c1"># permute into order of s0,s1;s0&#39;,s1&#39; where primed indices</span>
    <span class="c1"># represent &quot;ket&quot;</span>
    <span class="c1"># 0123-&gt;0213</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span></div>

<div class="viewcode-block" id="rdm3x1_sl"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm3x1_sl">[docs]</a><span class="k">def</span> <span class="nf">rdm3x1_sl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param sym_pos_def: make final density matrix symmetric and non-negative (default: False)</span>
<span class="sd">    :type sym_pos_def: bool</span>
<span class="sd">    :param force_cpu: compute on cpu</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 2-site reduced density matrix with indices :math:`s_0s_1;s&#39;_0s&#39;_1`</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 2-site reduced density matrix :math:`\rho_{3x1}` of a horizontal </span>
<span class="sd">    3x1 subsystem using following strategy:</span>
<span class="sd">    </span>
<span class="sd">        1. compute upper left 2x2 corner and lower left 2x1 corner</span>
<span class="sd">        2. construct left half of the network</span>
<span class="sd">        3. contract with extra T-a^+a-T column</span>
<span class="sd">        4. contract left and right half (identical to the left) to obtain final </span>
<span class="sd">           reduced density matrix</span>

<span class="sd">    ::</span>

<span class="sd">        C--T-----T-----T------C = C2x2--T----C2x2</span>
<span class="sd">        |  |     |     |      |     |   a^+a  |</span>
<span class="sd">        T--a^+a--a^+a--a^+a---T   C2x1--T----C2x1</span>
<span class="sd">        |  |     |     |      |</span>
<span class="sd">        C--T-----T-----T------C </span>

<span class="sd">    The physical indices `s` and `s&#39;` of on-sites tensors :math:`a` (and :math:`a^\dagger`) </span>
<span class="sd">    are left uncontracted and given in the following order::</span>
<span class="sd">        </span>
<span class="sd">        s0 c s1</span>

<span class="sd">    The resulting reduced density matrix is identical to the one of vertical 1x3 subsystem</span>
<span class="sd">    due to the C4v symmetry. </span>

<span class="sd">    This function avoids constructing double-layer on-site tensor explicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;rdm3x1_sl&quot;</span>
    <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
        <span class="c1"># move to cpu</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="c1">#----- building C2x2_LU ----------------------------------------------------</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ten_size</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>

    <span class="c1">#      ------&gt;</span>
    <span class="c1"># C--1 1--T--0</span>
    <span class="c1"># 0       2</span>
    <span class="n">C2x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x1: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># see _get_open_C2x2_LU_sl</span>
    <span class="n">C2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x1</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span>\
        <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">a</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x1,C2x2: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x1</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 4iv) fuse (some) pairs of aux indices</span>
    <span class="c1">#      -----&gt;</span>
    <span class="c1">#   C------T----0-&gt;2</span>
    <span class="c1"># A | 5&lt;-2\|\    </span>
    <span class="c1"># | T------a----4-&gt;3 </span>
    <span class="c1"># | | \    | |   </span>
    <span class="c1">#   |  ------a--7-&gt;4</span>
    <span class="c1">#   |      | |\5-&gt;6</span>
    <span class="c1">#   1-&gt;0  (3 6)-&gt;1</span>
    <span class="c1"># </span>
    <span class="c1"># permute and reshape 01234567-&gt;1(36)04725-&gt;0123456</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>\
        <span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x1,C2x2: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x1</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 0       2</span>
    <span class="c1"># C--1 0--T--1</span>
    <span class="c1">#      &lt;------</span>
    <span class="n">C2x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1">#----- build left part C2x2_LU--C2x1_LD ------------------------------------</span>
    <span class="c1"># /56-&gt;45</span>
    <span class="c1"># C2x2--2-&gt;1</span>
    <span class="c1"># |__|--3-&gt;2</span>
    <span class="c1"># | | \-4-&gt;3</span>
    <span class="c1"># 0 1</span>
    <span class="c1"># 0 2</span>
    <span class="c1"># C2x1--1-&gt;0</span>
    <span class="n">left_half</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x1</span><span class="p">,</span> <span class="n">C2x2</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> left_half: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">left_half</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#    2-&gt;2,3</span>
    <span class="c1"># 0--T--1</span>
    <span class="n">T</span><span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">T</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># /45-&gt;67</span>
    <span class="c1"># C2x2--1-&gt;3</span>
    <span class="c1"># |  |</span>
    <span class="c1"># |a |--2-&gt;4</span>
    <span class="c1"># | a|\-3-&gt;5</span>
    <span class="c1"># |  |       2,3-&gt;1,2</span>
    <span class="c1"># C2x1--0 0--T--1-&gt;0</span>
    <span class="c1">#         &lt;------</span>
    <span class="n">r3x1</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">left_half</span><span class="p">,([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1"># /67-&gt;78</span>
    <span class="c1"># C2x2--3-&gt;5</span>
    <span class="c1"># |  |</span>
    <span class="c1"># |a |--4-&gt;6</span>
    <span class="c1"># |  |       1</span>
    <span class="c1"># | a|\-5 2--a--4-&gt;2</span>
    <span class="c1"># |  |       3\0</span>
    <span class="c1"># |  |4&lt;-1--\2</span>
    <span class="c1"># C2x1-------T--0-&gt;3</span>
    <span class="n">r3x1</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">r3x1</span><span class="p">,([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
    <span class="c1"># /78-&gt;67</span>
    <span class="c1"># C2x2--5</span>
    <span class="c1"># |  |</span>
    <span class="c1"># |  |       1-&gt;0</span>
    <span class="c1"># |a |--6 2--a--4-&gt;1</span>
    <span class="c1"># |  |       3\0</span>
    <span class="c1"># |  |       4 0-\1-&gt;2</span>
    <span class="c1"># | a|\-----------a--2-&gt;3</span>
    <span class="c1"># |  |       \---\|</span>
    <span class="c1"># C2x1------------T--3-&gt;4</span>
    <span class="n">r3x1</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">r3x1</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">]))</span>
    <span class="c1"># /67-&gt;45  -----&gt;</span>
    <span class="c1"># C2x2--5 1--T-------0</span>
    <span class="c1"># |  |       2\---\</span>
    <span class="c1"># |  |       0    |</span>
    <span class="c1"># |a |-------a----|--1</span>
    <span class="c1"># |  |       |    3</span>
    <span class="c1"># |  |       |    2</span>
    <span class="c1"># | a|\-----------a--3-&gt;2</span>
    <span class="c1"># |  |       \---\|</span>
    <span class="c1"># C2x1------------T--4-&gt;3</span>
    <span class="c1">#              &lt;-----</span>
    <span class="n">r3x1</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">r3x1</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># construct reduced density matrix by contracting left and right halfs</span>
    <span class="c1">#   /45-&gt;01            /45-&gt;23</span>
    <span class="c1">#   C2x2----T----0 0--C2x1</span>
    <span class="c1">#   |  |    |\        |  |</span>
    <span class="c1"># A |a |----a-|--1 2--|  | | </span>
    <span class="c1"># | |  |    |\|       |  | V</span>
    <span class="c1">#   | a|\-----a--2 3--|  |</span>
    <span class="c1">#   |  |     \|       |  |</span>
    <span class="c1">#   C2x1------T--3 1--C2x2</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">r3x1</span><span class="p">,</span><span class="n">left_half</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> rdm: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">rdm</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># permute into order of s0,s1;s0&#39;,s1&#39; where primed indices</span>
    <span class="c1"># represent &quot;ket&quot;</span>
    <span class="c1"># 0123-&gt;0213</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span></div>

<span class="k">def</span> <span class="nf">rdm3x2_NNNN</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;_rdm2x2_NN_lowmem&quot;</span>
    <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="c1">#----- building C2x2_LU ----------------------------------------------------</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ten_size</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>

    <span class="n">dimsa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mefgh,mabcd-&gt;eafbgchd&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dimsa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">#   ---&gt;</span>
    <span class="c1"># A C2x2--1</span>
    <span class="c1"># | |__|</span>
    <span class="c1">#   |\23</span>
    <span class="c1">#   0</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">_get_open_C2x2_LU_sl</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="c1">#   ----&gt;</span>
    <span class="c1"># A C2x2c--1</span>
    <span class="c1"># | |___|</span>
    <span class="c1">#   |</span>
    <span class="c1">#   0</span>
    <span class="n">C2x2c</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abii-&gt;ab&#39;</span><span class="p">,</span><span class="n">C2x2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x2,C2x2c: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># prolong top left corner</span>
    <span class="c1">#</span>
    <span class="c1">#   ---&gt;         --&gt;            ---&gt;____                 ---&gt;___</span>
    <span class="c1"># A C2x2--1--1 1--T--0-&gt;4  =&gt;   C3x2 ___|--4-&gt;3     =&gt;   C3x2   |--3-&gt;2\</span>
    <span class="c1"># | |  |   \-2    2-&gt;5        A |   |   5 0            A |      |       &gt;2</span>
    <span class="c1">#   |__|     -&gt;1              | |___|1 1--A--3-&gt;5      | |______|--5-&gt;3/</span>
    <span class="c1">#   |\23-&gt;34-&gt;23                |  \      2-&gt;4           | |     \</span>
    <span class="c1">#   0                           0   23-&gt;12               0 4&gt;1   12&gt;45&gt;34</span>
    <span class="c1">#</span>
    <span class="n">C3x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">C3x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C3x2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">C3x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C3x2</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">C3x2</span><span class="o">=</span> <span class="n">C3x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">C2x2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># prolong bottom left corners</span>
    <span class="c1">#</span>
    <span class="c1">#   &lt;---         &lt;---            &lt;--- ____               &lt;--- __</span>
    <span class="c1">#   C2x2c--0--0 0--T--1-&gt;2  =&gt;   C3x2c ___|--2-&gt;1   =&gt;   C3x2c  |--1-&gt;2\</span>
    <span class="c1"># | |   |   \-1    2-&gt;3        | |    |   3 0          | |      |       &gt;2</span>
    <span class="c1"># V |___|    -&gt;0               V |____|0 1--A--3       V |______|--3---/</span>
    <span class="c1">#   |                            |          |            |  |   </span>
    <span class="c1">#   1&gt;2&gt;1                        1&gt;0        2            0  2&gt;1</span>
    <span class="c1">#</span>
    <span class="n">C3x2c</span><span class="o">=</span> <span class="n">C2x2c</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">C2x2c</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">C3x2c</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C3x2c</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">C3x2c</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C3x2c</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">C3x2c</span><span class="o">=</span> <span class="n">C3x2c</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C2x2c</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">C2x2c</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># build left edge</span>
    <span class="c1">#</span>
    <span class="c1">#       ---&gt;</span>
    <span class="c1">#   34--C3x2--2-&gt;1</span>
    <span class="c1"># -&gt;23  |  |</span>
    <span class="c1">#       0  1</span>
    <span class="c1">#       0  1</span>
    <span class="c1">#       |  |</span>
    <span class="c1">#       C3x2c--2-&gt;0</span>
    <span class="c1">#       &lt;---</span>
    <span class="c1">#</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C3x2c</span><span class="p">,</span><span class="n">C3x2</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># build right edge</span>
    <span class="c1">#</span>
    <span class="c1">#       ---&gt;                        ---&gt;        ---&gt;</span>
    <span class="c1">#   34--C3x2---1                23--C3x2---1 0--C2x2--23-&gt;12</span>
    <span class="c1"># -&gt;23  |  |                        |  |           1 </span>
    <span class="c1">#       |  |           0            |  |           0</span>
    <span class="c1">#       C3x2c--0 1--C2x2c           C3x2c-------C2x2c</span>
    <span class="c1">#       &lt;---        &lt;---            &lt;---        &lt;---</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">,</span><span class="n">rdm</span><span class="p">,([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span><span class="n">rdm</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># permute into order of s0,s1;s0&#39;,s1&#39; where primed indices</span>
    <span class="c1"># represent &quot;ket&quot;</span>
    <span class="c1"># 0123-&gt;0213</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span>


<div class="viewcode-block" id="rdm2x2_NN_lowmem"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm2x2_NN_lowmem">[docs]</a><span class="k">def</span> <span class="nf">rdm2x2_NN_lowmem</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param sym_pos_def: make final density matrix symmetric and non-negative (default: False)</span>
<span class="sd">    :type sym_pos_def: bool</span>
<span class="sd">    :param force_cpu: compute on cpu</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 2-site reduced density matrix with indices :math:`s_0s_1;s&#39;_0s&#39;_1`</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 2-site reduced density matrix :math:`\rho_{2x1}` of 2 sites </span>
<span class="sd">    that are nearest neighbours using strategy:</span>

<span class="sd">        1. compute upper left corner using double-layer on-site tensor</span>
<span class="sd">        2. construct upper half of the network</span>
<span class="sd">        3. contract upper and lower half (identical to upper) to obtain final reduced </span>
<span class="sd">           density matrix</span>

<span class="sd">    ::</span>

<span class="sd">        C--T-----T-----C = C2x2--C2x2c</span>
<span class="sd">        |  |     |     |   |     |</span>
<span class="sd">        T--A^+A--A^+A--T   C2x2--C2x2c</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        T--A^+A--A^+A--T</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        C--T-----T-----C</span>
<span class="sd">        </span>
<span class="sd">    The physical indices `s` and `s&#39;` of on-sites tensors :math:`a` (and :math:`a^\dagger`) </span>
<span class="sd">    inside C2x2 tensors are left uncontracted and given in the following order::</span>
<span class="sd">        </span>
<span class="sd">        s0 c</span>
<span class="sd">        s1 c</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_rdm2x2_NN_lowmem</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">env</span><span class="p">,</span><span class="n">_get_open_C2x2_LU_dl</span><span class="p">,</span><span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span>\
        <span class="n">force_cpu</span><span class="o">=</span><span class="n">force_cpu</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span></div>

<div class="viewcode-block" id="rdm2x2_NN_lowmem_sl"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm2x2_NN_lowmem_sl">[docs]</a><span class="k">def</span> <span class="nf">rdm2x2_NN_lowmem_sl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param sym_pos_def: make final density matrix symmetric and non-negative (default: False)</span>
<span class="sd">    :type sym_pos_def: bool</span>
<span class="sd">    :param force_cpu: compute on cpu</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 2-site reduced density matrix with indices :math:`s_0s_1;s&#39;_0s&#39;_1`</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 2-site reduced density matrix :math:`\rho_{2x1}` of 2 sites </span>
<span class="sd">    that are nearest neighbours using strategy:</span>

<span class="sd">        1. compute upper left corner using layer-by-layer contraction of on-site tensor </span>
<span class="sd">        2. construct upper half of the network</span>
<span class="sd">        3. contract upper and lower half (identical to upper) to obtain final reduced </span>
<span class="sd">           density matrix</span>

<span class="sd">    ::</span>

<span class="sd">        C--T-----T-----C = C2x2--C2x2c</span>
<span class="sd">        |  |     |     |   |     |</span>
<span class="sd">        T--a^+a--a^+a--T   C2x2--C2x2c</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        T--a^+a--a^+a--T</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        C--T-----T-----C</span>
<span class="sd">        </span>
<span class="sd">    The physical indices `s` and `s&#39;` of on-sites tensors :math:`a` (and :math:`a^\dagger`) </span>
<span class="sd">    inside C2x2 tensors are left uncontracted and given in the following order::</span>
<span class="sd">        </span>
<span class="sd">        s0 c</span>
<span class="sd">        s1 c</span>

<span class="sd">    This function avoids constructing double-layer on-site tensor explicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_rdm2x2_NN_lowmem</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">env</span><span class="p">,</span><span class="n">_get_open_C2x2_LU_sl</span><span class="p">,</span><span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span>\
        <span class="n">force_cpu</span><span class="o">=</span><span class="n">force_cpu</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_rdm2x2_NN_lowmem</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">f_c2x2</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;_rdm2x2_NN_lowmem&quot;</span>
    <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="c1">#----- building C2x2_LU ----------------------------------------------------</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ten_size</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>

    <span class="c1">#   ---&gt;</span>
    <span class="c1"># A C2x2--1</span>
    <span class="c1"># | |__|</span>
    <span class="c1">#   |\23</span>
    <span class="c1">#   0</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">f_c2x2</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="c1">#   ----&gt;</span>
    <span class="c1"># A C2x2c--1</span>
    <span class="c1"># | |___|</span>
    <span class="c1">#   |</span>
    <span class="c1">#   0</span>
    <span class="n">C2x2c</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abii-&gt;ab&#39;</span><span class="p">,</span><span class="n">C2x2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x2,C2x2c: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#----- build upper part C2x2 -- C2x2c -----------------------------------</span>
    <span class="c1"># C2x2c--1 0--C2x2    C2x2c--C2x2</span>
    <span class="c1"># |           | \     |      | \</span>
    <span class="c1"># 0           1  23   0      1 (23)-&gt;2</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">T</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">,</span><span class="n">C2x2</span><span class="p">,([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1"># C2x2c= torch.matmul(C2x2c,C2x2)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x2,C2x2c: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ----&gt;    ---&gt;</span>
    <span class="c1"># C2x2c----C2x2--2</span>
    <span class="c1"># |        |</span>
    <span class="c1"># 0        1</span>
    <span class="c1"># 0        1 </span>
    <span class="c1"># |        |</span>
    <span class="c1"># C2x2c----C2x2--2</span>
    <span class="c1">#rdm= torch.einsum(&#39;abi,abj-&gt;ij&#39;,C2x2,C2x2)</span>
    
    <span class="c1">#   ----&gt;    ---&gt;           ----&gt;       ---&gt;</span>
    <span class="c1">#   C2x2c----C2x2--2 |  =&gt;  C2x2c-------C2x2--2 |</span>
    <span class="c1">#   |        |       V      |           |       V</span>
    <span class="c1">#   0        1              |           1</span>
    <span class="c1">#   1                       |           0</span>
    <span class="c1">#   C2x2c--0                C2x2c--0 1--C2x2--2</span>
    <span class="c1">#   &lt;----                   &lt;----       &lt;---</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">,</span><span class="n">rdm</span><span class="p">,([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span><span class="n">rdm</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x2,C2x2c: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1"># permute into order of s0,s1;s0&#39;,s1&#39; where primed indices</span>
    <span class="c1"># represent &quot;ket&quot;</span>
    <span class="c1"># 0123-&gt;0213</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span>


<div class="viewcode-block" id="rdm2x2_NNN_lowmem"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm2x2_NNN_lowmem">[docs]</a><span class="k">def</span> <span class="nf">rdm2x2_NNN_lowmem</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param sym_pos_def: make final density matrix symmetric and non-negative (default: False)</span>
<span class="sd">    :type sym_pos_def: bool</span>
<span class="sd">    :param force_cpu: compute on cpu</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 2-site reduced density matrix with indices :math:`s_0s_1;s&#39;_0s&#39;_1`</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 2-site reduced density matrix :math:`\rho_{2x1}^{diag}` of 2 sites </span>
<span class="sd">    that are next-nearest neighbours (along diagonal) using strategy:</span>

<span class="sd">        1. compute upper left corner using double-layer on-site tensor</span>
<span class="sd">        2. construct upper half of the network</span>
<span class="sd">        3. contract upper and lower half (identical to upper) to obtain final reduced </span>
<span class="sd">           density matrix</span>

<span class="sd">    ::</span>

<span class="sd">        C--T-----T-----C = C2x2---C2x2c</span>
<span class="sd">        |  |     |     |   |      |</span>
<span class="sd">        T--a^+a--a^+a--T   C2x2c--C2x2</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        T--a^+a--a^+a--T</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        C--T-----T-----C</span>
<span class="sd">        </span>
<span class="sd">    The physical indices `s` and `s&#39;` of on-sites tensors :math:`A` (and :math:`A^\dagger`) </span>
<span class="sd">    inside C2x2 tensors are left uncontracted and given in the following order::</span>
<span class="sd">        </span>
<span class="sd">        s0 c</span>
<span class="sd">        c  s1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_rdm2x2_NNN_lowmem</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">env</span><span class="p">,</span><span class="n">_get_open_C2x2_LU_dl</span><span class="p">,</span><span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span>\
        <span class="n">force_cpu</span><span class="o">=</span><span class="n">force_cpu</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span></div>

<div class="viewcode-block" id="rdm2x2_NNN_lowmem_sl"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm2x2_NNN_lowmem_sl">[docs]</a><span class="k">def</span> <span class="nf">rdm2x2_NNN_lowmem_sl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param sym_pos_def: make final density matrix symmetric and non-negative (default: False)</span>
<span class="sd">    :type sym_pos_def: bool</span>
<span class="sd">    :param force_cpu: compute on cpu</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 2-site reduced density matrix with indices :math:`s_0s_1;s&#39;_0s&#39;_1`</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 2-site reduced density matrix :math:`\rho_{2x2}^{diag}` of 2 sites </span>
<span class="sd">    that are next-nearest neighbours (along diagonal) using strategy:</span>

<span class="sd">        1. compute upper left corner using layer-by-layer contraction of on-site tensor </span>
<span class="sd">        2. construct upper half of the network</span>
<span class="sd">        3. contract upper and lower half (identical to upper) to obtain final reduced </span>
<span class="sd">           density matrix</span>

<span class="sd">    ::</span>

<span class="sd">        C--T-----T-----C = C2x2---C2x2c</span>
<span class="sd">        |  |     |     |   |      |</span>
<span class="sd">        T--a^+a--a^+a--T   C2x2c--C2x2</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        T--a^+a--a^+a--T</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        C--T-----T-----C</span>
<span class="sd">        </span>
<span class="sd">    The physical indices `s` and `s&#39;` of on-sites tensors :math:`a` (and :math:`a^\dagger`) </span>
<span class="sd">    inside C2x2 tensors are left uncontracted and given in the following order::</span>
<span class="sd">        </span>
<span class="sd">        s0 c</span>
<span class="sd">        c  s1</span>

<span class="sd">    This function avoids constructing double-layer on-site tensor explicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_rdm2x2_NNN_lowmem</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">env</span><span class="p">,</span><span class="n">_get_open_C2x2_LU_sl</span><span class="p">,</span><span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> 
        <span class="n">force_cpu</span><span class="o">=</span><span class="n">force_cpu</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_rdm2x2_NNN_lowmem</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">f_c2x2</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;_rdm2x2_NNN_lowmem&quot;</span>
    <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
        <span class="c1"># move to cpu</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="c1">#----- building C2x2_LU ----------------------------------------------------</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ten_size</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>

    <span class="c1">#   ---&gt;</span>
    <span class="c1"># A C2x2--1</span>
    <span class="c1"># | |\23</span>
    <span class="c1">#   0</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">f_c2x2</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="c1">#   ----&gt; </span>
    <span class="c1"># A C2x2c--1</span>
    <span class="c1"># | |</span>
    <span class="c1">#   0</span>
    <span class="n">C2x2c</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abii-&gt;ab&#39;</span><span class="p">,</span><span class="n">C2x2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x2,C2x2c: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#----- build upper part C2x2 -- C2x2c -----------------------------------</span>
    <span class="c1"># ----&gt;       ---&gt;    ----&gt;  ---&gt;</span>
    <span class="c1"># C2x2c--1 0--C2x2    C2x2c--C2x2</span>
    <span class="c1"># |           | \     |      | \</span>
    <span class="c1"># 0           1  23   0      1 (23)-&gt;2</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">T</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">,</span><span class="n">C2x2</span><span class="p">,([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x2,C2x2c: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#     ---&gt;</span>
    <span class="c1">#  ---C2x2----</span>
    <span class="c1"># |          /|</span>
    <span class="c1"># 0   2=s0s0&#39; 1 </span>
    <span class="c1"># 1 2=s1s1&#39;   0</span>
    <span class="c1"># |/          | </span>
    <span class="c1">#  ---C2x2----</span>
    <span class="c1">#     &lt;---</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span><span class="n">C2x2</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">who</span><span class="si">}</span><span class="s2"> C2x2,C2x2c: </span><span class="si">{</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2</span><span class="p">)</span><span class="o">+</span><span class="n">ten_size</span><span class="p">(</span><span class="n">C2x2c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1"># permute into order of s0,s1;s0&#39;,s1&#39; where primed indices</span>
    <span class="c1"># represent &quot;ket&quot;</span>
    <span class="c1"># 0123-&gt;0213</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span>


<div class="viewcode-block" id="rdm2x2"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.rdm2x2">[docs]</a><span class="k">def</span> <span class="nf">rdm2x2</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param sym_pos_def: make final density matrix symmetric and non-negative (default: False)</span>
<span class="sd">    :type sym_pos_def: bool</span>
<span class="sd">    :param force_cpu: perform on CPU</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 4-site reduced density matrix with indices :math:`s_0s_1s_2s_3;s&#39;_0s&#39;_1s&#39;_2s&#39;_3`</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 4-site reduced density matrix :math:`\rho_{2x2}` of 2x2 subsystem using strategy:</span>

<span class="sd">        1. compute upper left corner</span>
<span class="sd">        2. construct upper half of the network</span>
<span class="sd">        3. contract upper and lower half (identical to upper) to obtain final reduced </span>
<span class="sd">           density matrix</span>
<span class="sd">    </span>
<span class="sd">    ::</span>

<span class="sd">        C--T-----T-----C = C2x2--C2x2</span>
<span class="sd">        |  |     |     |   |     |</span>
<span class="sd">        T--a^+a--a^+a--T   C2x2--C2x2</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        T--a^+a--a^+a--T</span>
<span class="sd">        |  |     |     |</span>
<span class="sd">        C--T-----T-----C</span>
<span class="sd">        </span>
<span class="sd">    The physical indices `s` and `s&#39;` of on-sites tensors :math:`A` (and :math:`A^\dagger`) </span>
<span class="sd">    are left uncontracted and given in the following order::</span>
<span class="sd">        </span>
<span class="sd">        s0 s1</span>
<span class="sd">        s2 s3</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#----- building C2x2_LU ----------------------------------------------------</span>
    <span class="n">who</span><span class="o">=</span> <span class="s2">&quot;rdm2x2&quot;</span>
    <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
        <span class="c1"># move to cpu</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="c1">#   ---&gt;</span>
    <span class="c1"># A C2x2--1</span>
    <span class="c1"># | |\23</span>
    <span class="c1">#   0</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">_get_open_C2x2_LU_dl</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1">#----- build upper part C2x2_LU--C2x2_RU -----------------------------------</span>
    <span class="c1"># ---&gt;       ---&gt;                 ---&gt;      ---&gt;</span>
    <span class="c1"># C2x2--1 0--C2x2                 C2x2------C2x2</span>
    <span class="c1"># |\23-&gt;12   |\23-&gt;45   &amp; permute |\12-&gt;23  |\45</span>
    <span class="c1"># 0          1-&gt;3                 0         3-&gt;1</span>
    <span class="c1"># TODO is it worthy(performance-wise) to instead overwrite one of C2x2_LU,C2x2_RU ?  </span>
    <span class="n">upper_half</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2</span><span class="p">,</span> <span class="n">C2x2</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">upper_half</span> <span class="o">=</span> <span class="n">upper_half</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1"># construct reduced density matrix by contracting lower and upper halfs</span>
    <span class="c1"># ---&gt;      ---&gt;</span>
    <span class="c1"># C2x2------C2x2   </span>
    <span class="c1"># |\23-&gt;01  |\45-&gt;23       </span>
    <span class="c1"># 0         1             </span>
    <span class="c1"># 1         0             </span>
    <span class="c1"># |/45-&gt;67  |/23-&gt;45     </span>
    <span class="c1"># C2x2------C2x2</span>
    <span class="c1"># &lt;---      &lt;---</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">upper_half</span><span class="p">,</span><span class="n">upper_half</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cpu</span> <span class="ow">and</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">_log_cuda_mem</span><span class="p">(</span><span class="n">loc_device</span><span class="p">,</span><span class="n">who</span><span class="p">)</span>

    <span class="c1"># permute into order of s0,s1,s2,s3;s0&#39;,s1&#39;,s2&#39;,s3&#39; where primed indices</span>
    <span class="c1"># represent &quot;ket&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># ---&gt;      ---&gt;</span>
    <span class="c1"># C2x2------C2x2</span>
    <span class="c1"># |\01      | \23</span>
    <span class="c1"># |/67-&gt;45  | /45-&gt;67</span>
    <span class="c1"># C2x2------C2x2</span>
    <span class="c1"># &lt;---      &lt;---</span>
    <span class="c1">#</span>
    <span class="c1"># 01234567-&gt;02641375</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># symmetrize and normalize</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">_sym_pos_def_rdm</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">sym_pos_def</span><span class="o">=</span><span class="n">sym_pos_def</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="n">who</span><span class="p">)</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rdm</span></div>

<span class="c1"># ----- density matrices in auxiliary space ------------------------------------</span>
<span class="c1">#TODO add tests</span>
<span class="k">def</span> <span class="nf">aux_rdm1x1</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
    <span class="n">a</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">dimsa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="c1">#   C--1-&gt;0</span>
    <span class="c1">#   0</span>
    <span class="c1"># A 0</span>
    <span class="c1"># | T--2</span>
    <span class="c1">#   1</span>
    <span class="n">CTC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">T</span><span class="p">,([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1">#   C--0</span>
    <span class="c1"># A |</span>
    <span class="c1"># | T--2-&gt;1</span>
    <span class="c1"># | 1</span>
    <span class="c1">#   0</span>
    <span class="c1">#   C--1-&gt;2</span>
    <span class="n">CTC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">CTC</span><span class="p">,</span><span class="n">C</span><span class="p">,([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1">#   C--0</span>
    <span class="c1"># A |</span>
    <span class="c1"># | T--1</span>
    <span class="c1"># | |       2-&gt;3</span>
    <span class="c1">#   C--2 0--T--1-&gt;2</span>
    <span class="c1">#        &lt;------</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">CTC</span><span class="p">,</span><span class="n">T</span><span class="p">,([</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1">#       ----&gt;</span>
    <span class="c1"># C--0 1--T--0-&gt;3</span>
    <span class="c1"># |       2-&gt;4</span>
    <span class="c1"># |       </span>
    <span class="c1"># T--1-&gt;0</span>
    <span class="c1"># |      </span>
    <span class="c1"># |       3-&gt;2</span>
    <span class="c1"># C-------T--2-&gt;1</span>
    <span class="c1">#      &lt;-----</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span><span class="n">T</span><span class="p">,([</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="c1">#   C----T--3 2--C</span>
    <span class="c1">#   |    4-&gt;2    |      C----T----C</span>
    <span class="c1"># A |            | |    |    0    |</span>
    <span class="c1"># | T--0  3&lt;-1---T | =&gt; T--1   3--T</span>
    <span class="c1"># | |            | V    |    2    |</span>
    <span class="c1">#   |    2-&gt;1    |      C----T----C</span>
    <span class="c1">#   C----T--1 0--C</span>
    <span class="n">rdm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span><span class="n">CTC</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="n">rdm</span><span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">rdm</span>

<div class="viewcode-block" id="aux_rdm2x2_NN"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.aux_rdm2x2_NN">[docs]</a><span class="k">def</span> <span class="nf">aux_rdm2x2_NN</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param force_cpu: execute on cpu</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 2-site auxilliary reduced density matrix</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 2-site auxiliary reduced density matrix of nearest neighbours </span>
<span class="sd">    within 2x2 subsystem without the on-site tensors (leaving corresponding </span>
<span class="sd">    auxiliary indices open) using strategy:</span>

<span class="sd">        1. compute upper left corner</span>
<span class="sd">        2. construct upper half of the network</span>
<span class="sd">        3. contract upper and lower half (identical to upper) to obtain final reduced </span>
<span class="sd">           auxilliary density matrix</span>

<span class="sd">    :: </span>

<span class="sd">          C----T----T----C    = aC2x2--aC2x2</span>
<span class="sd">          |    0    5    |      |       |</span>
<span class="sd">          T--1        4--T      C2x2----C2x2</span>
<span class="sd">          |    2    3    |</span>
<span class="sd">          C----T----T----C</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#----- building pC2x2_LU ----------------------------------------------------</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">dimsa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">aC2x2</span><span class="o">=</span> <span class="n">_get_aux_C2x2_LU</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="c1">#----- build upper part aC2x2_LU--aC2x2_RU -----------------------------------</span>
    <span class="c1"># aC2x2----1 1----aC2x2</span>
    <span class="c1"># |_  \          /   _|</span>
    <span class="c1"># | |  3-&gt;2  5&lt;-3   | |</span>
    <span class="c1"># 0 2               2 0</span>
    <span class="c1">#   V               V V</span>
    <span class="c1">#   1               4 3</span>
    <span class="c1"># aC2x2 = torch.tensordot(aC2x2, aC2x2, ([1],[1]))</span>
    <span class="c1"># =====================</span>
    <span class="c1"># ----&gt;           ----&gt;</span>
    <span class="c1"># aC2x2----1 0----aC2x2</span>
    <span class="c1"># |_  \          /   _|</span>
    <span class="c1"># | |  3-&gt;2  4&lt;-2   | |</span>
    <span class="c1"># 0 2               3 1</span>
    <span class="c1">#   V               V V</span>
    <span class="c1">#   1               5 3</span>
    <span class="n">aC2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">aC2x2</span><span class="p">,</span> <span class="n">aC2x2</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># ---&gt;       ---&gt;</span>
    <span class="c1"># C2x2--1 =&gt; C2x2--1</span>
    <span class="c1"># | \        |</span>
    <span class="c1"># 0  23      0</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">_get_open_C2x2_LU_sl</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abii-&gt;ab&#39;</span><span class="p">,</span><span class="n">C2x2</span><span class="p">)</span>
    <span class="c1"># ---&gt;       -----&gt;</span>
    <span class="c1"># C2x2--1 =&gt; C2x2_d--2-&gt;1</span>
    <span class="c1"># |          | |</span>
    <span class="c1"># 0          0 1-&gt;2</span>
    <span class="n">C2x2_d</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),(</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">C2x2_d</span><span class="o">=</span> <span class="n">C2x2_d</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># ---&gt;       -----&gt;</span>
    <span class="c1"># C2x2--1 =&gt; C2x2_r--1</span>
    <span class="c1"># |          |    \--2 (right)</span>
    <span class="c1"># 0          0</span>
    <span class="n">C2x2_r</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># -----&gt;         -----&gt;   </span>
    <span class="c1"># C2x2_d--1 0----C2x2_r</span>
    <span class="c1"># |  |           |  |</span>
    <span class="c1"># 0  2-&gt;1        2  1</span>
    <span class="c1">#                V  V</span>
    <span class="c1">#                3  2</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">C2x2_d</span><span class="p">,</span><span class="n">C2x2_r</span><span class="p">,([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># construct reduced density matrix by contracting lower and upper halfs</span>
    <span class="c1">#  __________________         __________________</span>
    <span class="c1"># |_______aC2x2______|       |______aC2x2_______|    C----T----T----C</span>
    <span class="c1"># | | \          / | |       | | \          / | |    |    1    3    |</span>
    <span class="c1"># 0 1  2        5  4 3       | 0  1        3  2 |    T--0        2--T</span>
    <span class="c1"># 0                  3  =&gt;   |                  | =&gt; |              |</span>
    <span class="c1"># | 1  2        5  4 |       | 4  5        7  6 |    T--4        6--T</span>
    <span class="c1"># |_|_/__________\_|_|       |_|_/__________\_|_|    |    5    7    |</span>
    <span class="c1"># |_______C2x2_______|       |_______C2x2_______|    C----T----T----C</span>
    <span class="c1"># ===================================================================</span>
    <span class="c1">#  _______-----&gt;_____         __________________</span>
    <span class="c1"># |_______aC2x2______|       |_______aC2x2______|    C----T----T----C</span>
    <span class="c1"># | | \          / | |       | |   \      /   | |    |    0    3    |</span>
    <span class="c1"># 0 1  2        4  5 3       | 0(l) 1(u) 2 (r)3 |    T--1        5--T</span>
    <span class="c1"># 2                  0  =&gt;   |                  | =&gt; |    2    4    |</span>
    <span class="c1"># | 3              1 |       | 5(d)           4 |    C----T----T----C</span>
    <span class="c1"># |_|______________|_|       |_|______________|_|</span>
    <span class="c1"># |_______C2x2_______|       |________C2x2______|</span>
    <span class="c1">#         &lt;---</span>
    <span class="n">aC2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">aC2x2</span><span class="p">,</span><span class="n">C2x2</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># permute such, that aux-index increases from &quot;up&quot; in the anti-clockwise direction</span>
    <span class="c1"># aC2x2 = aC2x2.permute(1,0,4,5,7,6,2,3).contiguous()</span>
    <span class="c1"># ===================================================</span>
    <span class="n">aC2x2</span> <span class="o">=</span> <span class="n">aC2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="c1"># reshape and form bra and ket index</span>
    <span class="n">aC2x2</span> <span class="o">=</span> <span class="n">aC2x2</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">aC2x2</span></div>

<div class="viewcode-block" id="aux_rdm2x2"><a class="viewcode-back" href="../../../envs/one_site_c4v/rdm_c4v.html#ctm.one_site_c4v.rdm_c4v.aux_rdm2x2">[docs]</a><span class="k">def</span> <span class="nf">aux_rdm2x2</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param state: underlying 1-site C4v symmetric wavefunction</span>
<span class="sd">    :param env: C4v symmetric environment corresponding to ``state``</span>
<span class="sd">    :param force_cpu: execute on cpu</span>
<span class="sd">    :param verbosity: logging verbosity</span>
<span class="sd">    :type state: IPEPS_C4V</span>
<span class="sd">    :type env: ENV_C4V</span>
<span class="sd">    :type force_cpu: bool</span>
<span class="sd">    :type verbosity: int</span>
<span class="sd">    :return: 4-site auxilliary reduced density matrix</span>
<span class="sd">    :rtype: torch.tensor</span>

<span class="sd">    Computes 4-site auxiliary reduced density matrix :math:`\rho_{2x2}` of 2x2 subsystem </span>
<span class="sd">    without the on-site tensors (leaving corresponding auxiliary indices open)</span>
<span class="sd">    using strategy:</span>

<span class="sd">        1. compute upper left corner</span>
<span class="sd">        2. construct upper half of the network</span>
<span class="sd">        3. contract upper and lower half (identical to upper) to obtain final reduced </span>
<span class="sd">           auxilliary density matrix</span>

<span class="sd">    :: </span>

<span class="sd">          C----T----T----C    = C2x2--C2x2</span>
<span class="sd">          |    0    7    |      |     |</span>
<span class="sd">          T--1        6--T      C2x2--C2x2</span>
<span class="sd">          |              |</span>
<span class="sd">          T--2        5--T</span>
<span class="sd">          |    3    4    |</span>
<span class="sd">          C----T----T----C</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO try single torch.einsum ?</span>
    <span class="c1">#----- building pC2x2_LU ----------------------------------------------------</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">dimsa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">loc_device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
    <span class="n">is_cpu</span><span class="o">=</span> <span class="n">loc_device</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="c1">#  ---&gt;</span>
    <span class="c1"># A |C2x2____|--1  </span>
    <span class="c1"># | | |     3 </span>
    <span class="c1"># | |_|--2</span>
    <span class="c1">#    0</span>
    <span class="n">aC2x2</span><span class="o">=</span> <span class="n">_get_aux_C2x2_LU</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="c1">#----- build upper part aC2x2_LU--aC2x2_RU -----------------------------------</span>
    <span class="c1"># aC2x2----1 1----aC2x2</span>
    <span class="c1"># |_  \          /   _|</span>
    <span class="c1"># | |  3-&gt;2  5&lt;-3   | |</span>
    <span class="c1"># 0 2               2 0</span>
    <span class="c1">#   V               V V</span>
    <span class="c1">#   1               4 3</span>
    <span class="c1"># aC2x2 = torch.tensordot(aC2x2, aC2x2, ([1],[1]))</span>
    <span class="c1"># =====================</span>
    <span class="c1"># ----&gt;           ----&gt;</span>
    <span class="c1"># aC2x2----1 0----aC2x2</span>
    <span class="c1"># |_  \          /   _|</span>
    <span class="c1"># | |  3-&gt;2  4&lt;-2   | |</span>
    <span class="c1"># 0 2               3 1</span>
    <span class="c1">#   V               V V</span>
    <span class="c1">#   1               5 3</span>
    <span class="n">aC2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">aC2x2</span><span class="p">,</span> <span class="n">aC2x2</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># construct reduced density matrix by contracting lower and upper halfs</span>
    <span class="c1">#  __________________         __________________</span>
    <span class="c1"># |_______aC2x2______|       |__________________|    C----T----T----C</span>
    <span class="c1"># | | \          / | |       | | \          / | |    |    1    3    |</span>
    <span class="c1"># 0 1  2        5  4 3       | 0  1        3  2 |    T--0        2--T</span>
    <span class="c1"># 0                  3  =&gt;   |                  | =&gt; |              |</span>
    <span class="c1"># | 1  2        5  4 |       | 4  5        7  6 |    T--4        6--T</span>
    <span class="c1"># |_|_/__________\_|_|       |_|_/__________\_|_|    |    5    7    |</span>
    <span class="c1"># |_______aC2x2______|       |_______aC2x2______|    C----T----T----C</span>
    <span class="c1"># ===================================================================</span>
    <span class="c1">#  _______----&gt;______         __________________</span>
    <span class="c1"># |_______aC2x2______|       |__________________|    C----T----T----C</span>
    <span class="c1"># | | \          / | |       | |   \        / | |    |    0    2    |</span>
    <span class="c1"># 0 1  2        4  5 3       | 0(l) 1(u)   2  3 |    T--1        3--T</span>
    <span class="c1"># 3                  0  =&gt;   |                  | =&gt; |              |</span>
    <span class="c1"># | 5  4        2  1 |       | 6(l) 7(d)   5  4 |    T--4        7--T</span>
    <span class="c1"># |_|_/__________\_|_|       |_|___/________\_|_|    |    5    6    |</span>
    <span class="c1"># |_______aC2x2______|       |_______aC2x2______|    C----T----T----C</span>
    <span class="c1">#         &lt;----</span>
    <span class="n">aC2x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">aC2x2</span><span class="p">,</span><span class="n">aC2x2</span><span class="p">,([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># permute such, that aux-index increases from &quot;up&quot; in the anti-clockwise direction</span>
    <span class="c1"># aC2x2 = aC2x2.permute(1,0,4,5,7,6,2,3).contiguous()</span>
    <span class="c1"># ===================================================</span>
    <span class="n">aC2x2</span> <span class="o">=</span> <span class="n">aC2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="c1"># reshape and form bra and ket index</span>
    <span class="n">aC2x2</span> <span class="o">=</span> <span class="n">aC2x2</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="n">dimsa</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">aC2x2</span></div>


<span class="k">def</span> <span class="nf">test_symm_open_C2x2_LU</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">_get_open_C2x2_LU_sl</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="n">tC2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open C2x2-C2x2^t </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">C2x2</span><span class="o">-</span><span class="n">tC2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">C2x2</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijaa-&gt;ij&#39;</span><span class="p">,</span><span class="n">C2x2</span><span class="p">)</span>
    <span class="n">chi</span><span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">chi</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># |C2x2|--2    |C2x2|--1</span>
    <span class="c1"># |____|--3 =&gt; |____|--3</span>
    <span class="c1"># 0  1         0  2</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="n">tC2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C2x2-C2x2^t </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">C2x2</span><span class="o">-</span><span class="n">tC2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">tC2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C2x2-C2x2^t(env) </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">C2x2</span><span class="o">-</span><span class="n">tC2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">tC2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C2x2-C2x2^t(aux) </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">C2x2</span><span class="o">-</span><span class="n">tC2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_symm_aux_C2x2_LU</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyC</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">keyT</span><span class="p">]</span>
    <span class="n">C2x2</span><span class="o">=</span> <span class="n">_get_aux_C2x2_LU</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">T</span><span class="p">)</span>

    <span class="n">tC2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C2x2-C2x2^t </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">C2x2</span><span class="o">-</span><span class="n">tC2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">tC2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C2x2-C2x2^t(env) </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">C2x2</span><span class="o">-</span><span class="n">tC2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">tC2x2</span><span class="o">=</span> <span class="n">C2x2</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C2x2-C2x2^t(aux) </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">C2x2</span><span class="o">-</span><span class="n">tC2x2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Juraj Hasik, Glen B. Mbeng

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>